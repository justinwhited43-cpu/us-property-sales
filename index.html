<script>
  const map = L.map('map').setView([39.917, -83.808], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const legend = L.control({ position: "bottomleft" });
  let legendDiv;

  legend.onAdd = function () {
    legendDiv = L.DomUtil.create("div");
    legendDiv.style.background = "white";
    legendDiv.style.padding = "10px";
    legendDiv.style.borderRadius = "6px";
    legendDiv.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
    return legendDiv;
  };

  legend.addTo(map);

  let sales = [];
  let markers = [];
  let currentType = "all";
  let maxDays = 30;

  fetch("sales.csv")
    .then(res => res.text())
    .then(text => {
      const rows = text.trim().split("\n").slice(1);
      sales = rows.map(row => {
        const [lat, lon, price, type, daysAgo] = row.split(",");
        return {
          lat: +lat,
          lon: +lon,
          price: `$${Number(price).toLocaleString()}`,
          type,
          daysAgo: +daysAgo
        };
      });
      draw();
    });

  function draw() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    let houseCount = 0;
    let lotCount = 0;

    sales.forEach(sale => {
      if (sale.daysAgo > maxDays) return;
      if (currentType !== "all" && sale.type !== currentType) return;

      const color = sale.type === "house" ? "#1d4ed8" : "#92400e";

      const marker = L.circleMarker([sale.lat, sale.lon], {
        radius: 7,
        fillColor: color,
        color: "#000",
        weight: 1,
        fillOpacity: 0.8
      })
        .addTo(map)
        .bindPopup(
          `<strong>${sale.price}</strong><br>
           ${sale.type.toUpperCase()}<br>
           Sold ${sale.daysAgo} days ago`
        );

      markers.push(marker);

      sale.type === "house" ? houseCount++ : lotCount++;
    });

    legendDiv.innerHTML = `
      <strong>Legend</strong><br>
      ðŸ”µ Houses: ${houseCount}<br>
      ðŸŸ¤ Lots: ${lotCount}<br>
      <em>Last ${maxDays} days</em>
    `;
  }

  window.setType = type => {
    currentType = type;
    draw();
  };

  window.setDays = days => {
    maxDays = days;
    draw();
  };
</script>
